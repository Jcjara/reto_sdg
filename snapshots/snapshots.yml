version: 2

snapshots:
  - name: sat_customer_attributes
    description: "SCD2 snapshot of customer descriptive attributes."
    columns:
      - name: CUSTOMER_HK
        tests: [not_null]
      - name: DBT_VALID_FROM
        tests:
          - not_null
      - name: DBT_VALID_TO
        description: "Null means current row."
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "DBT_VALID_FROM < coalesce(DBT_VALID_TO, to_timestamp('2999-12-31'))"
      - dbt_expectations.expect_compound_columns_to_be_unique:
          arguments:
            column_list: ["CUSTOMER_HK", "DBT_VALID_FROM"]
      - at_most_one_current_row:
          key: CUSTOMER_HK

  - name: sat_link_ops_lineattr
    description: "SCD2 snapshot of line attributes (line grain) for order–part–supplier."
    columns:
      - name: LINK_HK
        tests: [not_null]
      - name: DBT_VALID_FROM
        tests:
          - not_null
      - name: DBT_VALID_TO
        description: "Null means current row."
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "DBT_VALID_FROM < coalesce(DBT_VALID_TO, to_timestamp('2999-12-31'))"
      - dbt_expectations.expect_compound_columns_to_be_unique:
          arguments:
            column_list: ["LINK_HK", "DBT_VALID_FROM"]
      - at_most_one_current_row:
          key: LINK_HK
